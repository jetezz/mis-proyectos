---
import Layout from '../layouts/Layout.astro';
import { createSupabaseServerClient } from '../lib/supabase-server';

// ── AUTH GUARD SERVER-SIDE ────────────────────────────────────────
const supabase = createSupabaseServerClient(Astro.request.headers, Astro.cookies);
const { data: { user }, error } = await supabase.auth.getUser();
if (!user || error) return Astro.redirect('/login');
---

<Layout title="Dashboard">
  <!-- Nav -->
  <nav class="navbar">
    <div class="nav-inner">
      <div class="nav-logo">
        <svg width="28" height="28" viewBox="0 0 36 36" fill="none">
          <rect width="36" height="36" rx="10" fill="#5b5bf6" fill-opacity="0.15"/>
          <path d="M10 18L16 12L22 18L28 12" stroke="#5b5bf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M10 24L16 18L22 24L28 18" stroke="#7070ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>OpenCode Agent</span>
      </div>
      <div class="nav-right">
        <span id="user-email" class="user-email"></span>
        <button id="logout-btn" class="btn btn-secondary">Salir</button>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="main">
    <div class="page-header">
      <div>
        <h1 class="page-title">Mis Proyectos</h1>
        <p class="page-subtitle">Terminal interactiva en la nube — trabaja con OpenCode, Claude Code o cualquier herramienta</p>
      </div>
      <button id="add-project-btn" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Añadir Proyecto
      </button>
    </div>

    <!-- Projects list -->
    <div id="projects-container">
      <div id="projects-loading" class="loading-state">
        <div class="spinner-large"></div>
        <p>Cargando proyectos...</p>
      </div>
      <div id="projects-empty" class="empty-state" style="display:none;">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        <h3>Sin proyectos todavía</h3>
        <p>Añade tu primer repositorio para empezar a trabajar con tu terminal cloud</p>
        <button class="btn btn-primary" onclick="document.getElementById('add-project-btn').click()">
          Añadir primer proyecto
        </button>
      </div>
      <div id="projects-grid" class="projects-grid" style="display:none;"></div>
    </div>
  </main>

  <!-- ── Modal: Añadir Proyecto ─────────────────────────────────────── -->
  <div id="add-modal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h2>Añadir Proyecto</h2>
        <button id="close-add-modal" class="modal-close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="repo-url">URL del repositorio</label>
          <input id="repo-url" type="url" class="input" placeholder="https://github.com/usuario/repositorio"/>
          <span class="field-hint">Solo se aceptan URLs HTTPS de GitHub o GitLab</span>
        </div>
        <div id="add-error" class="error-inline" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button id="cancel-add" class="btn btn-secondary">Cancelar</button>
        <button id="confirm-add" class="btn btn-primary">
          <span id="add-btn-text">Clonar Repositorio</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ── Modal: Editar Proyecto ───────────────────────────────────── -->
  <div id="edit-modal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h2>Editar Proyecto</h2>
        <button id="close-edit-modal" class="modal-close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="edit-name">Nombre del proyecto</label>
          <input id="edit-name" type="text" class="input" placeholder="Mi proyecto"/>
        </div>
        <div id="edit-error" class="error-inline" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button id="cancel-edit" class="btn btn-secondary">Cancelar</button>
        <button id="confirm-edit" class="btn btn-primary">
          <span id="edit-btn-text">Guardar Cambios</span>
        </button>
      </div>
    </div>
  </div>
</Layout>


<script>
  import { supabase } from '../lib/supabase';
  import { getProjects, addProject, deleteProject, updateProject } from '../lib/api';
  import type { Project } from '../lib/api';


  // ── Init ─────────────────────────────────────────────────────
  supabase.auth.getSession().then(({ data: { session } }) => {
    const emailEl = document.getElementById('user-email');
    if (emailEl && session?.user?.email) emailEl.textContent = session.user.email;
    loadProjects();
  });

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/login';
  });

  // ── Projects ──────────────────────────────────────────────────
  async function loadProjects() {
    const loading = document.getElementById('projects-loading')!;
    const empty = document.getElementById('projects-empty')!;
    const grid = document.getElementById('projects-grid')!;
    try {
      const projects = await getProjects();
      loading.style.display = 'none';
      if (projects.length === 0) {
        empty.style.display = 'flex';
        grid.style.display = 'none';
      } else {
        empty.style.display = 'none';
        grid.style.display = 'grid';
        renderProjects(projects);
      }
    } catch (err) {
      loading.innerHTML = `<p style="color:var(--danger)">Error cargando proyectos: ${(err as Error).message}</p>`;
    }
  }

  function renderProjects(projects: Project[]) {
    const grid = document.getElementById('projects-grid')!;
    grid.innerHTML = projects.map(p => `
      <div class="project-card card" data-id="${p.id}">
        <div class="project-card-header">
          <div class="project-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <span class="badge badge-success">Clonado</span>
        </div>
        <h3 class="project-name">${p.name}</h3>
        <p class="project-url">${p.repoUrl}</p>
        <p class="project-date">Añadido ${new Date(p.createdAt).toLocaleDateString('es')}</p>
        <div class="project-actions">
          <a href="/project/${p.id}" class="btn btn-primary btn-sm terminal-link">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            Abrir Terminal
          </a>
          <button class="btn btn-secondary btn-sm edit-btn" data-id="${p.id}" data-name="${p.name}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1-1-4 9.5-9.5z"></path>
            </svg>
          </button>
          <button class="btn btn-danger btn-sm delete-btn" data-id="${p.id}">

            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14H6L5 6"></path>
            </svg>
          </button>
        </div>
      </div>
    `).join('');

    grid.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = (btn as HTMLElement).dataset.id!;
        if (!confirm('¿Eliminar este proyecto? Esta acción no se puede deshacer.')) return;
        try { await deleteProject(id); loadProjects(); }
        catch (err) { alert(`Error eliminando: ${(err as Error).message}`); }
      });
    });

    grid.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = (btn as HTMLElement).dataset.id!;
        const name = (btn as HTMLElement).dataset.name!;
        openEditModal(id, name);
      });
    });
  }

  // ── Add Project Modal ─────────────────────────────────────────

  const addModal = document.getElementById('add-modal')!;
  const addError = document.getElementById('add-error')!;

  document.getElementById('add-project-btn')?.addEventListener('click', () => {
    addModal.style.display = 'flex';
    (document.getElementById('repo-url') as HTMLInputElement).value = '';
    addError.style.display = 'none';
  });
  document.getElementById('close-add-modal')?.addEventListener('click', () => { addModal.style.display = 'none'; });
  document.getElementById('cancel-add')?.addEventListener('click', () => { addModal.style.display = 'none'; });

  document.getElementById('confirm-add')?.addEventListener('click', async () => {
    const repoUrl = (document.getElementById('repo-url') as HTMLInputElement).value.trim();
    const confirmBtn = document.getElementById('confirm-add') as HTMLButtonElement;
    const btnText = document.getElementById('add-btn-text')!;
    addError.style.display = 'none';
    if (!repoUrl) { addError.textContent = 'Introduce una URL de repositorio.'; addError.style.display = 'block'; return; }
    confirmBtn.disabled = true;
    btnText.textContent = 'Clonando...';
    try { await addProject(repoUrl); addModal.style.display = 'none'; loadProjects(); }
    catch (err) { addError.textContent = (err as Error).message; addError.style.display = 'block'; }
    finally { confirmBtn.disabled = false; btnText.textContent = 'Clonar Repositorio'; }
  });

  addModal.addEventListener('click', (e) => { if (e.target === addModal) addModal.style.display = 'none'; });

  // Tecla Escape cierra modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (addModal.style.display !== 'none') addModal.style.display = 'none';
      if (editModal.style.display !== 'none') editModal.style.display = 'none';
    }
  });

  // ── Edit Project Modal ────────────────────────────────────────
  const editModal = document.getElementById('edit-modal')!;
  const editError = document.getElementById('edit-error')!;
  const editInput = document.getElementById('edit-name') as HTMLInputElement;
  let currentEditingId = '';

  function openEditModal(id: string, name: string) {
    currentEditingId = id;
    editInput.value = name;
    editError.style.display = 'none';
    editModal.style.display = 'flex';
    editInput.focus();
  }

  document.getElementById('close-edit-modal')?.addEventListener('click', () => { editModal.style.display = 'none'; });
  document.getElementById('cancel-edit')?.addEventListener('click', () => { editModal.style.display = 'none'; });

  document.getElementById('confirm-edit')?.addEventListener('click', async () => {
    const newName = editInput.value.trim();
    const confirmBtn = document.getElementById('confirm-edit') as HTMLButtonElement;
    const btnText = document.getElementById('edit-btn-text')!;
    editError.style.display = 'none';

    if (!newName) {
      editError.textContent = 'El nombre no puede estar vacío.';
      editError.style.display = 'block';
      return;
    }

    confirmBtn.disabled = true;
    btnText.textContent = 'Guardando...';

    try {
      await updateProject(currentEditingId, newName);
      editModal.style.display = 'none';
      loadProjects();
    } catch (err) {
      editError.textContent = (err as Error).message;
      editError.style.display = 'block';
    } finally {
      confirmBtn.disabled = false;
      btnText.textContent = 'Guardar Cambios';
    }
  });

  editModal.addEventListener('click', (e) => { if (e.target === editModal) editModal.style.display = 'none'; });
</script>


<style>
  .navbar {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.85);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }
  .nav-inner {
    max-width: 1200px; margin: 0 auto; padding: 0 1.5rem;
    height: 60px; display: flex; align-items: center; justify-content: space-between;
  }
  .nav-logo { display: flex; align-items: center; gap: 0.625rem; font-weight: 600; font-size: 1rem; }
  .nav-right { display: flex; align-items: center; gap: 1rem; }
  .user-email { font-size: 0.8125rem; color: var(--text-secondary); }

  .main { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
  .page-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; margin-bottom: 2rem; }
  .page-title { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.02em; }
  .page-subtitle { color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem; }

  .loading-state, .empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 1rem; padding: 4rem; text-align: center; color: var(--text-secondary);
  }
  .empty-state svg { opacity: 0.3; }
  .empty-state h3 { color: var(--text-primary); font-size: 1.125rem; }
  .empty-state p { font-size: 0.875rem; max-width: 300px; }
  .spinner-large { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
  .project-card { display: flex; flex-direction: column; gap: 0.5rem; transition: all 0.2s; }
  .project-card:hover { border-color: rgba(91,91,246,0.4); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .project-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
  .project-icon {
    width: 36px; height: 36px; background: rgba(91,91,246,0.1); border: 1px solid rgba(91,91,246,0.2);
    border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--accent);
  }
  .project-name { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .project-url { font-size: 0.8rem; color: var(--text-secondary); font-family: var(--font-mono); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .project-date { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; }
  .project-actions { display: flex; gap: 0.5rem; margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); }
  .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8125rem; }
  .project-actions .terminal-link { flex: 1; justify-content: center; text-decoration: none; }

  /* ── Modals ─────────────────────────────────────────────────── */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px); z-index: 200;
    display: flex; align-items: center; justify-content: center; padding: 1.5rem;
  }
  .modal {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); width: 100%; max-width: 480px;
    box-shadow: 0 32px 80px rgba(0,0,0,0.6); animation: modal-in 0.2s ease;
  }
  @keyframes modal-in { from { opacity: 0; transform: scale(0.96) translateY(8px); } to { opacity: 1; transform: scale(1) translateY(0); } }
  .modal-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 1.5rem; border-bottom: 1px solid var(--border); }
  .modal-header h2 { font-size: 1.125rem; font-weight: 600; }
  .modal-close { background: none; border: none; color: var(--text-muted); padding: 0.25rem; border-radius: 4px; transition: color 0.2s, background 0.2s; }
  .modal-close:hover { color: var(--text-primary); background: var(--bg-card-hover); }
  .modal-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
  .modal-footer { display: flex; gap: 0.75rem; justify-content: flex-end; padding: 1.25rem 1.5rem; border-top: 1px solid var(--border); }
  .form-group { display: flex; flex-direction: column; gap: 0.375rem; }
  .form-group label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
  .field-hint { font-size: 0.75rem; color: var(--text-muted); }
  .error-inline { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: var(--danger); padding: 0.625rem 0.875rem; border-radius: var(--radius-sm); font-size: 0.8125rem; }
</style>
