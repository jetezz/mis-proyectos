---
import Layout from '../layouts/Layout.astro';
import { createSupabaseServerClient } from '../lib/supabase-server';

// Si ya hay sesión activa → redirigir al dashboard directamente
const supabase = createSupabaseServerClient(Astro.request.headers, Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (user) {
  return Astro.redirect('/dashboard');
}
---

<Layout title="Login">
  <div class="login-container">
    <div class="login-card">
      <!-- Logo / Header -->
      <div class="login-header">
        <div class="logo">
          <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
            <rect width="36" height="36" rx="10" fill="#5b5bf6" fill-opacity="0.15"/>
            <path d="M10 18L16 12L22 18L28 12" stroke="#5b5bf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 24L16 18L22 24L28 18" stroke="#7070ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>OpenCode Agent</span>
        </div>
        <h1>Acceder al Panel</h1>
        <p>Autentícate para gestionar tus proyectos de código de forma segura</p>
      </div>

      <!-- Error message (si viene de redirect)  -->
      <div id="error-msg" class="error-banner" style="display:none;"></div>

      <!-- Formulario de login -->
      <form id="login-form" class="login-form" novalidate>
        <div class="form-group">
          <label for="email">Email</label>
          <input
            id="email"
            type="email"
            class="input"
            placeholder="tu@email.com"
            required
            autocomplete="email"
          />
        </div>

        <div class="form-group">
          <label for="password">Contraseña</label>
          <input
            id="password"
            type="password"
            class="input"
            placeholder="••••••••"
            required
            autocomplete="current-password"
          />
        </div>

        <button id="login-btn" type="submit" class="btn btn-primary login-btn">
          <span id="btn-text">Entrar</span>
          <span id="btn-spinner" style="display:none;">
            <svg class="spinner" viewBox="0 0 24 24" fill="none" width="16" height="16">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-dasharray="31.4" stroke-dashoffset="10"/>
            </svg>
          </span>
        </button>
      </form>

      <!-- Divider -->
      <div class="divider"><span>o</span></div>

      <!-- Magic Link -->
      <button id="magic-link-btn" class="btn btn-secondary magic-btn">
        Enviar enlace mágico al email
      </button>

      <p class="register-link">
        ¿No tienes cuenta? <a href="#" id="register-link">Crear cuenta</a>
      </p>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('login-form') as HTMLFormElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const loginBtn = document.getElementById('login-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text')!;
  const btnSpinner = document.getElementById('btn-spinner')!;
  const errorMsg = document.getElementById('error-msg')!;
  const magicLinkBtn = document.getElementById('magic-link-btn') as HTMLButtonElement;
  const registerLink = document.getElementById('register-link')!;

  function setLoading(loading: boolean) {
    loginBtn.disabled = loading;
    btnText.style.display = loading ? 'none' : 'inline';
    btnSpinner.style.display = loading ? 'inline' : 'none';
  }

  function showError(message: string) {
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
  }

  function hideError() {
    errorMsg.style.display = 'none';
  }

  // Login con email + password
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();
    setLoading(true);

    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!email || !password) {
      showError('Por favor, completa todos los campos.');
      setLoading(false);
      return;
    }

    const { error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      showError(error.message);
      setLoading(false);
      return;
    }

    window.location.href = '/dashboard';
  });

  // Magic Link
  magicLinkBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    if (!email) {
      showError('Introduce tu email primero.');
      return;
    }

    hideError();
    magicLinkBtn.disabled = true;
    magicLinkBtn.textContent = 'Enviando...';

    const { error } = await supabase.auth.signInWithOtp({ email });

    if (error) {
      showError(error.message);
      magicLinkBtn.disabled = false;
      magicLinkBtn.textContent = 'Enviar enlace mágico al email';
    } else {
      magicLinkBtn.textContent = '✓ Enlace enviado — revisa tu email';
    }
  });

  // Registro
  registerLink.addEventListener('click', async (e) => {
    e.preventDefault();
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!email || !password) {
      showError('Completa email y contraseña para registrarte.');
      return;
    }

    hideError();
    setLoading(true);

    const { error } = await supabase.auth.signUp({ email, password });

    if (error) {
      showError(error.message);
    } else {
      showError('✓ Cuenta creada. Revisa tu email para confirmarla.');
      (errorMsg as HTMLElement).style.color = 'var(--success)';
    }

    setLoading(false);
  });
</script>

<style>
  .login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
  }

  .login-card {
    width: 100%;
    max-width: 420px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2.5rem;
    box-shadow: 0 24px 64px rgba(0, 0, 0, 0.5);
  }

  .login-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .logo {
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
  }

  .login-header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .login-header p {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .error-banner {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: var(--danger);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .form-group label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .login-btn {
    width: 100%;
    justify-content: center;
    padding: 0.75rem;
    font-size: 0.9375rem;
    margin-top: 0.5rem;
  }

  .spinner {
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .divider {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1.5rem 0;
    color: var(--text-muted);
    font-size: 0.8125rem;
  }

  .divider::before,
  .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .magic-btn {
    width: 100%;
    justify-content: center;
    padding: 0.625rem;
  }

  .register-link {
    text-align: center;
    font-size: 0.8125rem;
    color: var(--text-muted);
    margin-top: 1.25rem;
  }
</style>
